<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
</head>

<body onload="addSightingsToMap()">
    <div id="map" style="width: 100%; height: 600px;"></div>
    <button id="addPointButton" onclick="addRandomPoint()">Add Random Point</button>
    <button id="clearPointsButton" onclick="clearPoints()">Clear All Points</button>
    <button id="getLocation" onclick="getLocation()">Get location</button>


    <div>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Animal</th>
                    <th>Last Seen</th>
                </tr>
            </thead>
            <tbody>
                {% for sighting in sightings %}
                <tr class="sightingRow"
                    onmouseenter="addMapMarker('{{sighting.latitude}}', '{{sighting.longitude}}')"
                    onmouseleave="removeMapMarker()">
                    <td>{{ sighting.id }}</td>
                        <td>
                            {% if sighting.animalType_id == 1 %}
                                dog
                            {% else %}
                                {{ sighting.animalType_id }}
                            {% endif %}
                        </td>
                    <td>{{ sighting.lastSeen }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</body>

<style>
    #map{
        cursor: pointer;
    }

    table {
        border-collapse: collapse;
    }
    table, th, td{
        border: 2px solid black;
    }
    .sightingRow{
        transition: all 0.25s ease;

    }
    .sightingRow:hover{
        background-color: aquamarine;
        cursor: pointer;
    }
</style>

<script>
    const x = 17.543610;
    const y = 78.574729;
    var map = L.map('map', {
        minZoom: 16,
        maxZoom: 18,
        maxBounds: [
            [17.550314, 78.565750],
            [17.536213, 78.580764]
        ]
    }).setView([x, y], 16);
    let max_heat_map_val = 0;

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        //maxZoom: 17,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    map.on('click', function(e) {
        var lat = e.latlng.lat; // Latitude of the clicked point
        var lng = e.latlng.lng; // Longitude of the clicked point
    
        // Do something with the lat and lng values, such as displaying them
        console.log('You clicked at: Lat ' + lat + ', Lng ' + lng);
    })

    // Create an empty array to store heatmap data
    var heatmapData = [];

    // Create a heatmap layer using Leaflet.heat
    var heatmapLayer = L.heatLayer(heatmapData, {
        radius: 30, // Adjust the radius
        max: 1.0,   // Adjust the maximum
    }).addTo(map);

    // Function to add a random point to the heatmap
    function addRandomPoint() {
        var randomLat = x + Math.random() * 0.005; // Adjust latitude range as needed
        var randomLong = y + Math.random() * 0.005; // Adjust longitude range as needed
        var randomIntensity = 1 ;
        
        addPoint(randomLat, randomLong, randomIntensity);
    }

    function clearPoints(){
        heatmapData = [];
        max_heat_map_val = 0;

        map.removeLayer(heatmapLayer);
        heatmapLayer = L.heatLayer(heatmapData, {
            radius: 10,
            max: 0.1,
        }).addTo(map);

        console.log("Cleared all points; Current max: ", max_heat_map_val);

    }

    function addPoint(lat, long, intensity){
        var newPoint = [lat, long, intensity];
        heatmapData.push(newPoint);

        if(intensity > max_heat_map_val)
            max_heat_map_val = intensity;

        map.removeLayer(heatmapLayer);
        heatmapLayer = L.heatLayer(heatmapData, {
            radius: 10,
            max: 0.1,
        }).addTo(map);

        console.log('Added new point:', newPoint, " Current max: ", max_heat_map_val);
    }

    // Not very accurate, gets location using location API
    function getLocation(){
        if ('geolocation' in navigator) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var latitude = position.coords.latitude;
                var longitude = position.coords.longitude;

                console.log(`${latitude},${longitude}`)
            });
        } else {
            console.error('Geolocation is not available in this browser.');
        }
    }

    // adds sightings from passed context to map
    function addSightingsToMap(){
        let lat = 0
        let long = 0 
        {%for sighting in sightings%}
            lat = +'{{sighting.latitude}}'
            long = +'{{sighting.longitude}}'
            addPoint(lat, long, 1);
        {% endfor %}
        
    }


    // For when you hover on table
    var currentHoverMarker = null;

    // Adds marker when you hover on table
    function addMapMarker(latitude, longitude){
        if(currentHoverMarker != null){
            map.removeLayer(currentHoverMarker);
            currentHoverMarker = null;
        }

        currentHoverMarker = L.marker([+latitude, +longitude]).addTo(map);
    }

    // Removes marker when you stop hovering
    function removeMapMarker(){
        if(currentHoverMarker != null){
            map.removeLayer(currentHoverMarker);
            currentHoverMarker = null;
        }
    }


</script>

</html>
